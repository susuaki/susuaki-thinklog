<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <title>ã‚¹ã‚¹ã‚¢ã‚­æ—¥è¨˜</title>
</head>
<body>
  <main>
    <h1>ã‚¹ã‚¹ã‚¢ã‚­æ—¥è¨˜</h1>
    <form id="entry-form">
      <label>ğŸ“Œ ä»Šæ—¥ã®ä»®èª¬
        <textarea name="hypothesis" placeholder="ä»®èª¬ãŒã‚ã‚Œã°è¨˜å…¥"></textarea>
      </label>
      <label>ğŸ§© å°ã•ãªé¸æŠã¨ç†ç”±
        <textarea name="decision" placeholder="å°ã•ãªé¸æŠã¨ç†ç”±"></textarea>
      </label>
      <label>ğŸ§  æ°—ã«ãªã£ãŸè¨€è‘‰ï¼å•ã„
        <textarea name="quote" placeholder="æ°—ã«ãªã£ãŸè¨€è‘‰ã‚„å•ã„"></textarea>
      </label>
      <label>ğŸ” å®Ÿé¨“ã—ã¦ã¿ãŸã“ã¨
        <textarea name="experiment" placeholder="è©¦ã—ãŸã“ã¨ãŒã‚ã‚Œã°è¨˜å…¥"></textarea>
      </label>
      <label>ğŸ“‰ é•å’Œæ„Ÿ or ç–‘å•
        <textarea name="doubt" placeholder="ãƒ¢ãƒ¤ãƒƒã¨ã—ãŸã“ã¨ãªã©"></textarea>
      </label>
      <label>ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢ã®ç¨®
        <textarea name="idea" placeholder="æ€ã„ã¤ã„ãŸã“ã¨ãŒã‚ã‚Œã°"></textarea>
      </label>
      <button type="submit">ä¿å­˜</button>
    </form>

    <div style="margin-top: 1rem">
      <label>ğŸ“… é–‹å§‹æ—¥ï¼š<input type="date" id="start-date"></label>
      <label>ğŸ“… çµ‚äº†æ—¥ï¼š<input type="date" id="end-date"></label>
      <button id="export-button">è¨˜éŒ²ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦å‰Šé™¤</button>
    </div>

    <section id="entries"></section>
  </main>
  <script>
    const dbName = 'SusuakiDiaryDB';
    const storeName = 'entries';

    let db;
    const request = indexedDB.open(dbName, 1);

    request.onupgradeneeded = event => {
      db = event.target.result;
      db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
    };

    request.onsuccess = event => {
      db = event.target.result;
      loadEntries();
    };

    document.getElementById('entry-form').addEventListener('submit', e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      if (Object.values(data).every(value => value.trim() === '')) return;
      const tx = db.transaction(storeName, 'readwrite');
      tx.objectStore(storeName).add({ ...data, date: new Date().toISOString() });
      tx.oncomplete = () => {
        e.target.reset();
        loadEntries();
      };
    });

    document.getElementById('export-button').addEventListener('click', () => {
      const startInput = document.getElementById('start-date').value;
      const endInput = document.getElementById('end-date').value;
      if (!startInput || !endInput) return alert('æ—¥ä»˜ã‚’æ­£ã—ãæŒ‡å®šã—ã¦ãã ã•ã„');

      const start = new Date(startInput);
      const end = new Date(endInput);
      end.setHours(23, 59, 59, 999); // çµ‚äº†æ—¥ã‚’ãã®æ—¥ã®çµ‚ã‚ã‚Šã¾ã§æ‹¡å¼µ

      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const getRequest = store.getAll();

      getRequest.onsuccess = () => {
        const allEntries = getRequest.result;
        const matched = allEntries.filter(e => {
          const d = new Date(e.date);
          return d >= start && d <= end;
        });

        if (matched.length === 0) return alert('æŒ‡å®šç¯„å›²ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

        const blob = new Blob([JSON.stringify(matched, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `susuaki-diary-${start.toISOString().split('T')[0]}_to_${end.toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);

        matched.forEach(entry => {
          store.delete(entry.id);
        });

        tx.oncomplete = () => loadEntries();
      };
    });

    function loadEntries() {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const request = store.getAll();

      request.onsuccess = () => {
        const entries = request.result.reverse();
        const container = document.getElementById('entries');
        container.innerHTML = entries.map(entry => `
          <details>
            <summary>${new Date(entry.date).toLocaleString()}</summary>
            <ul>
              <li><strong>ä»®èª¬:</strong> ${entry.hypothesis}</li>
              <li><strong>é¸æŠã¨ç†ç”±:</strong> ${entry.decision}</li>
              <li><strong>å•ã„:</strong> ${entry.quote}</li>
              <li><strong>å®Ÿé¨“:</strong> ${entry.experiment}</li>
              <li><strong>é•å’Œæ„Ÿ:</strong> ${entry.doubt}</li>
              <li><strong>ã‚¢ã‚¤ãƒ‡ã‚¢:</strong> ${entry.idea}</li>
            </ul>
            <button class="delete-button" data-id="${entry.id}">å‰Šé™¤</button>
          </details>
        `).join('');

        document.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', e => {
            const id = Number(e.target.dataset.id);
            const tx = db.transaction(storeName, 'readwrite');
            tx.objectStore(storeName).delete(id);
            tx.oncomplete = () => loadEntries();
          });
        });
      };
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
</body>
</html>
