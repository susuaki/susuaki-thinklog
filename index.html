<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <title>ThinkLog</title>
</head>
<body>
  <main>
    <h1>ThinkLog</h1>
    <form id="entry-form">
      <label>📌 今日の仮説
        <textarea name="hypothesis" placeholder="仮説があれば記入"></textarea>
      </label>
      <label>🧩 小さな選択と理由
        <textarea name="decision" placeholder="小さな選択と理由"></textarea>
      </label>
      <label>🧠 気になった言葉／問い
        <textarea name="quote" placeholder="気になった言葉や問い"></textarea>
      </label>
      <label>🔁 実験してみたこと
        <textarea name="experiment" placeholder="試したことがあれば記入"></textarea>
      </label>
      <label>📉 違和感 or 疑問
        <textarea name="doubt" placeholder="モヤッとしたことなど"></textarea>
      </label>
      <label>💡 アイデアの種
        <textarea name="idea" placeholder="思いついたことがあれば"></textarea>
      </label>
      <label>📝 その他メモや気づき
        <textarea name="notes" placeholder="自由に記録したいことがあれば"></textarea>
      </label>
      <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button type="reset">キャンセル</button>
        <button type="submit">保存</button>
      </div>
    </form>

    <div style="margin-top: 1rem">
      <label>📅 開始日：<input type="date" id="start-date"></label>
      <label>📅 終了日：<input type="date" id="end-date"></label>
      <button id="export-button">記録をエクスポートして削除</button>
    </div>

    <section id="entries"></section>
  </main>
  <script>
    const dbName = 'SusuakiDiaryDB';
    const storeName = 'entries';

    let db;
    const request = indexedDB.open(dbName, 1);

    request.onupgradeneeded = event => {
      db = event.target.result;
      db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
    };

    request.onsuccess = event => {
      db = event.target.result;
      loadEntries();
    };

    document.getElementById('entry-form').addEventListener('submit', e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      if (Object.values(data).every(value => value.trim() === '')) return;
      const tx = db.transaction(storeName, 'readwrite');
      tx.objectStore(storeName).add({ ...data, date: new Date().toISOString() });
      tx.oncomplete = () => {
        e.target.reset();
        loadEntries();
      };
    });

    document.getElementById('export-button').addEventListener('click', () => {
      const startInput = document.getElementById('start-date').value;
      const endInput = document.getElementById('end-date').value;
      if (!startInput || !endInput) return alert('日付を正しく指定してください');

      const start = new Date(startInput);
      const end = new Date(endInput);
      end.setHours(23, 59, 59, 999);

      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const getRequest = store.getAll();

      getRequest.onsuccess = () => {
        const allEntries = getRequest.result;
        const matched = allEntries.filter(e => {
          const d = new Date(e.date);
          return d >= start && d <= end;
        });

        if (matched.length === 0) return alert('指定範囲の記録が見つかりません');

        const blob = new Blob([JSON.stringify(matched, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `thinklog-data-${start.toISOString().split('T')[0]}_to_${end.toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);

        if (confirm('ファイルは保存できましたか？該当記録を削除してもよいですか？')) {
          const deleteTx = db.transaction(storeName, 'readwrite');
          const deleteStore = deleteTx.objectStore(storeName);
          matched.forEach(entry => {
            deleteStore.delete(entry.id);
          });
          deleteTx.oncomplete = () => loadEntries();
        }
      };
    });

    function loadEntries() {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const request = store.getAll();

      request.onsuccess = () => {
        const entries = request.result.reverse();
        const container = document.getElementById('entries');
        container.innerHTML = ''; // Clear previous entries

        entries.forEach(entry => {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = new Date(entry.date).toLocaleString();

          const ul = document.createElement('ul');
          const createLi = (label, text) => {
            const li = document.createElement('li');
            const strong = document.createElement('strong');
            strong.textContent = `${label}: `;
            li.appendChild(strong);
            li.appendChild(document.createTextNode(text || ''));
            return li;
          };

          ul.appendChild(createLi('仮説', entry.hypothesis));
          ul.appendChild(createLi('選択と理由', entry.decision));
          ul.appendChild(createLi('問い', entry.quote));
          ul.appendChild(createLi('実験', 'experiment'));
          ul.appendChild(createLi('違和感', entry.doubt));
          ul.appendChild(createLi('アイデア', entry.idea));
          ul.appendChild(createLi('メモ', entry.notes));

          const deleteButton = document.createElement('button');
          deleteButton.className = 'delete-button';
          deleteButton.dataset.id = entry.id;
          deleteButton.textContent = '削除';
          deleteButton.addEventListener('click', e => {
            const id = Number(e.target.dataset.id);
            const tx = db.transaction(storeName, 'readwrite');
            tx.objectStore(storeName).delete(id);
            tx.oncomplete = () => loadEntries();
          });

          details.appendChild(summary);
          details.appendChild(ul);
          details.appendChild(deleteButton);
          container.appendChild(details);
        });
      };
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
</body>
</html>
